<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Expired To Be: Convenient Expiration Reminders</title><meta name="theme-color" content="#000000"><link rel="manifest" href="manifest.json"><link rel="shortcut icon" href="icon32.png" id="dynamic-favicon"><link rel="stylesheet" href="extensions/chrome/popup.css"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-1872941-9"></script><script>if(0<=location.href.toLowerCase().indexOf("kdcinfo")){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-1872941-9")}</script><link href="/expired-to-be/static/css/main.2f95c8c9.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="web-root"></div><div id="root"></div><script>function htmlEscape(str) {
        const ourStr = str
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\//g, '&#x2F;'); // forward slash is included as it helps end an HTML entity
        return ourStr;
      }

      function htmlUnescape(str){
        const ourStr = str
          .replace(/&quot;/g, '"')
          .replace(/&#39;/g, "'")
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&amp;/g, '&')
          .replace(/&#x2F;/g, '/');
        return ourStr;
      }

      //
      // Expired To Be [Web App] - STATE MANAGEMENT
      //

      function ExpiredToBe() {
        if (!(this instanceof ExpiredToBe)) {
          return new ExpiredToBe();
        }
        this.items = []; // Item objects (item ID and whichEvent) to be passed to our TimerBox `alarms` API.
        this.alarms = [];
        this.prefs = {
          prefNotification: 'alerts', // alerts|modals|notifications|none (only passive)
          prefAlarmMsg: 'An alarm has expired.',
          prefCycle: 0,       // 0 = 'daily'; Snooze is not currently integrated (cycle only affects Timers).
          prefHours: 9,       // [0-23] 0 = Midnight (tonight), 1 AM, etc.
          prefMins: 0,        // [0-55] 0 = Top of the hour.
          prefSnoozeTime: 5,  // Used for Timers (not currently integrated).
          showPanel: false,   // The Alarms panel (visual display) is currently only intended for informative output.
          allowTimers: false  // Timers are coded but not currently integrated as they are on 'Done (for now)'.
        };
        this.notifyError = '';
        // Item to Process:
        // item[] = {
        //   whichEvent: 'add',        whichEvent: 'remove',  //   whichEvent: 'update',
        //   expiredId: timeId,        expiredId: timeId,     //   expiredId: timeId
        //   entryTitle: alarmId,                             //   entryTitle: alarmId
        //   entryPresetTargetTime: 0,                        //   resetTargetTime: 0,
        //   entryHours: numberHours,                         //   entryHours: numberHours
        //   entryMinutes: 0,                                 //   entryMinutes: 0
        //   entryCycle: 0 // daily [hr:1 | min:2]            //   entryCycle: 0
        // };
        this.removeLocalAlarm = (itemId) => {
          let thisAlarms = this.alarms.slice();
          thisAlarms = thisAlarms.filter(elem => elem.id !== itemId);
          this.alarms = thisAlarms;
        };
        this.clearErrMsg = () => {
          this.notifyError = '';
          this.updateErrorMsg();
        };
        this.updateErrorMsg = () => {
          document.getElementById('notify-error').innerText = htmlUnescape(this.notifyError);
        };
        this.getPermReturn = (isAlarm = false) => {

          return new Promise( (resolve, reject) => {
            this.clearErrMsg();

            // Return Strings: none|granted|denied|default

            if (!('Notification' in window)) {
              resolve('none'); // Device does not support desktop notification

            } else if (isAlarm) {
              resolve(Notification.permission);

            } else if (Notification.permission === 'granted') {
              // Let's check whether notification permissions have alredy been granted
              // If it's okay let's create a notification
              // var notification = new Notification('Hi there!');
              resolve('granted');

            } else if (Notification.permission === 'default') {
              // Otherwise, we need to ask the user for permission
              // else if (Notification.permission !== 'denied' || Notification.permission === 'default') {

              try {

                Notification.requestPermission().then(permission => {

                  if (permission === 'denied' || permission === 'granted') {
                    // User denied|granted permissions
                    resolve(permission);
                  }

                  if (permission === 'default') {

                    if (window.Notification.permission === 'denied') {
                      // The browser has decided to automatically deny permission.
                      // https://stackoverflow.com/questions/47263967/chrome-treats-default-result-from-notification-requestpermission-as-denied#answer-47516416
                      resolve('autodeny');
                    }
                    resolve(permission);
                  } else {
                    resolve(permission);
                  }
                });

              } catch (error) {
                // Safari doesn't return a promise for requestPermissions and it throws a TypeError.
                // It takes a callback as the first argument instead.
                if (error instanceof TypeError) {
                  Notification.requestPermission(permission => {
                    resolve(permission);
                  });

                } else {
                  throw error;
                  resolve('none');
                }
              }
            } else if (Notification.permission === 'default') {
              if (Notification.permission === 'denied') {
                resolve('denied');
              }
              resolve('default');

            } else {
              resolve('denied');
            }
          });
        };
        return {
          currentItems: () => this.items,
          alarmItems: () => this.alarms,
          getPrefs: () => this.prefs,
          setPref: (ourPrefs) => {
            let whichData = Object.assign({}, this.prefs, ourPrefs);
            this.prefs = whichData;
          },
          setAlarms: (ourAlarms) => {
            this.alarms = ourAlarms;
          },
          getAlarm: (itemId) => this.alarms.find(
            alarm => parseInt(alarm.title.substr(4), 10) === itemId
          ),
          refreshAlarms: () => {
            showList(); // @TONOTE: This doesn't exist yet, but it will when [popup.js] is loaded.
          },
          removeAlarm: (itemId) => {
            this.removeLocalAlarm(itemId);
          },
          processItem: (itemObj) => {
            if (itemObj.whichEvent === 'remove') {
              this.removeLocalAlarm(itemObj.expiredId);
            } else if (itemObj.whichEvent === 'clearall') {
              this.alarms.length = 0;
            }
            this.items.push(itemObj);
          },
          removeItem: (itemId) => {
            let thisIdx = this.items.findIndex( item => item.id === itemId );
            let newItems = this.items.slice();
            newItems.splice(thisIdx, 1);
            this.items = newItems;
          },
          //
          // Get Web Notifications API Permissions
          //
          // https://developer.mozilla.org/en-US/docs/Web/API/Notification/permission
          // https://stackoverflow.com/questions/38114266/web-notifications-not-appearing-in-safari#answer-39282539
          //
          getPermissions: (isAlarm = false) => {
            // Let's check if the browser supports notifications
            return this.getPermReturn().then( thisPerm => {
              return thisPerm; // 2018-03-23 - Gotta return something so you have something to be returned. :P
            });
          },
          setError: (errMsg) => {
            this.notifyError = htmlEscape(errMsg);
            this.updateErrorMsg();
          },
          clearErrors: () => {
            this.clearErrMsg();
          },
          updatePassiveNotification: () => {
            runPassiveNotification('1');
          },
          triggerAlarm: (timerId) => {

            this.getPermReturn(true).then( thisPerm => {

              // updatePassiveNotification(); // props call to `updatePassiveNotification` is done separate and first.
              if (thisPerm === 'granted') {
                let msgTxt = 'One of your Expiration items is set to expire!',
                    msg = new Notification( 'Expired To Be', {
                              body: msgTxt, // + ' Your Expiration items are at: https://kdcinfo.com/expired-to-be',
                              icon: 'icon32.png'
                          });

                msg.addEventListener( 'click', event => {
                  // message(msgTxt, true);
                  parent.focus();
                  window.focus();
                  event.target.close();
                });
              } else {
                message('An expiration alarm was triggered, ' +
                        'but notification permissions have been revoked since the alarm was originally set.', true);
              }
            });
          }
        };
      }
      window.ourExpirations = window.ourExpirations || new ExpiredToBe();</script><script>!function(l){function e(e){for(var r,t,n=e[0],o=e[1],u=e[2],i=0,f=[];i<n.length;i++)t=n[i],p[t]&&f.push(p[t][0]),p[t]=0;for(r in o)Object.prototype.hasOwnProperty.call(o,r)&&(l[r]=o[r]);for(s&&s(e);f.length;)f.shift()();return c.push.apply(c,u||[]),a()}function a(){for(var e,r=0;r<c.length;r++){for(var t=c[r],n=!0,o=1;o<t.length;o++){var u=t[o];0!==p[u]&&(n=!1)}n&&(c.splice(r--,1),e=i(i.s=t[0]))}return e}var t={},p={2:0},c=[];function i(e){if(t[e])return t[e].exports;var r=t[e]={i:e,l:!1,exports:{}};return l[e].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=l,i.c=t,i.d=function(e,r,t){i.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(r,e){if(1&e&&(r=i(r)),8&e)return r;if(4&e&&"object"==typeof r&&r&&r.__esModule)return r;var t=Object.create(null);if(i.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:r}),2&e&&"string"!=typeof r)for(var n in r)i.d(t,n,function(e){return r[e]}.bind(null,n));return t},i.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(r,"a",r),r},i.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},i.p="/expired-to-be/";var r=window.webpackJsonp=window.webpackJsonp||[],n=r.push.bind(r);r.push=e,r=r.slice();for(var o=0;o<r.length;o++)e(r[o]);var s=n;a()}([])</script><script src="/expired-to-be/static/js/1.aab29c2b.chunk.js"></script><script src="/expired-to-be/static/js/main.eadf2f55.chunk.js"></script></body></html>